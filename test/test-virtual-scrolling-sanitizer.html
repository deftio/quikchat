<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90' style='fill:blue'>&#x1F4AC;</text></svg>"
        rel="icon" />
    <title>Virtual Scrolling + Sanitizer Test</title>
    <link rel="stylesheet" href="../dist/quikchat.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chat-container {
            height: 500px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .status {
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Virtual Scrolling + Sanitizer Test</h1>
    
    <div class="status" id="status">
        <p>Testing virtual scrolling with sanitization enabled...</p>
    </div>

    <div style="margin-bottom: 20px;">
        <button onclick="addMessages(100)">Add 100 Messages</button>
        <button onclick="addMessages(500)">Add 500 Messages (Trigger Virtual)</button>
        <button onclick="addMessages(1000)">Add 1000 Messages</button>
        <button onclick="testXSS()">Test XSS Content</button>
        <button onclick="clearAll()">Clear All</button>
        <button onclick="checkDOM()">Check DOM Count</button>
    </div>

    <div class="container">
        <div>
            <h3>With Sanitizer + Virtual Scrolling</h3>
            <div id="chat1" class="chat-container"></div>
        </div>
        <div>
            <h3>No Sanitizer + Virtual Scrolling</h3>
            <div id="chat2" class="chat-container"></div>
        </div>
    </div>

    <script src="../dist/quikchat.umd.min.js"></script>
    <script>
        // Initialize chats with virtual scrolling and sanitizer
        window.chat1 = new quikchat('#chat1', function(instance, message) {
            // Add the user's message
            instance.messageAddNew(message, 'User', 'right');
            // Simulate a response
            setTimeout(function() {
                instance.messageAddNew('Response to: ' + message, 'Bot', 'left');
            }, 500);
        }, {
            sanitizer: quikchat.sanitizers.escapeHTML,
            virtualScrolling: true,
            virtualScrollingThreshold: 500
        });
        
        window.chat2 = new quikchat('#chat2', function(instance, message) {
            // Add the user's message
            instance.messageAddNew(message, 'User', 'right');
            // Simulate a response
            setTimeout(function() {
                instance.messageAddNew('Response to: ' + message, 'Bot', 'left');
            }, 500);
        }, {
            virtualScrolling: true,
            virtualScrollingThreshold: 500
        });
        
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.innerHTML = '<p class="' + (isError ? 'error' : '') + '">' + message + '</p>';
        }
        
        function addMessages(count) {
            updateStatus('Adding ' + count + ' messages...');
            
            const startTime = performance.now();
            
            for (let i = 0; i < count; i++) {
                // Create content with XSS attempt - avoiding template literals that break HTML
                const content = '<b>Message #' + i + '</b> with <' + 'script>alert("xss")</' + 'script> content';
                window.chat1.messageAddNew(content, 'User ' + (i % 3), i % 2 === 0 ? 'right' : 'left');
                window.chat2.messageAddNew(content, 'User ' + (i % 3), i % 2 === 0 ? 'right' : 'left');
            }
            
            const endTime = performance.now();
            const time = (endTime - startTime).toFixed(2);
            
            // Check virtual scrolling status
            const vs1Status = window.chat1.isVirtualScrollingEnabled() ? 'ACTIVE' : 'INACTIVE';
            const vs2Status = window.chat2.isVirtualScrollingEnabled() ? 'ACTIVE' : 'INACTIVE';
            
            updateStatus(
                'Added ' + count + ' messages in ' + time + 'ms<br>' +
                'Chat 1 (with sanitizer): Virtual Scrolling ' + vs1Status + '<br>' +
                'Chat 2 (no sanitizer): Virtual Scrolling ' + vs2Status + '<br>' +
                'Total messages: ' + window.chat1.historyGetLength()
            );
            
            // Check if content is properly sanitized
            setTimeout(function() {
                checkSanitization();
            }, 100);
        }
        
        function testXSS() {
            const xssPayloads = [
                '<' + 'script>window.xssTest = "failed";</' + 'script>Test 1',
                '<img src=x onerror="window.xssTest=\'failed\'">Test 2',
                '<svg onload="window.xssTest=\'failed\'">Test 3</svg>',
                'Normal message with <b>bold</b> and <i>italic</i>'
            ];
            
            xssPayloads.forEach(function(payload, i) {
                window.chat1.messageAddNew(payload, 'Attacker', 'left');
                window.chat2.messageAddNew(payload, 'Attacker', 'left');
            });
            
            setTimeout(function() {
                if (window.xssTest) {
                    updateStatus('⚠️ XSS vulnerability detected! Script executed.', true);
                } else {
                    updateStatus('✅ XSS prevented successfully!', false);
                }
                checkSanitization();
            }, 100);
        }
        
        function checkSanitization() {
            // Get visible messages from chat1 (with sanitizer)
            const chat1Messages = document.querySelectorAll('#chat1 .quikchat-message-content');
            let sanitized = 0;
            let unsanitized = 0;
            
            chat1Messages.forEach(function(msg) {
                if (msg.innerHTML.includes('&lt;script&gt;')) {
                    sanitized++;
                } else if (msg.innerHTML.includes('<script>')) {
                    unsanitized++;
                }
            });
            
            if (unsanitized > 0) {
                console.error('Found unsanitized content in virtual scrolling!', {
                    sanitized: sanitized,
                    unsanitized: unsanitized,
                    total: chat1Messages.length
                });
                updateStatus('⚠️ Virtual scrolling sanitization issue: ' + unsanitized + ' unsanitized messages found!', true);
            }
        }
        
        function checkDOM() {
            const chat1DOM = document.querySelectorAll('#chat1 .quikchat-message').length;
            const chat2DOM = document.querySelectorAll('#chat2 .quikchat-message').length;
            const history = window.chat1.historyGetLength();
            
            const vs1 = window.chat1.getVirtualScrollingConfig();
            const vs2 = window.chat2.getVirtualScrollingConfig();
            
            updateStatus(
                '<strong>DOM Analysis:</strong><br>' +
                'Chat 1: ' + chat1DOM + ' DOM nodes (Virtual: ' + (vs1.active ? 'ACTIVE' : 'INACTIVE') + ')<br>' +
                'Chat 2: ' + chat2DOM + ' DOM nodes (Virtual: ' + (vs2.active ? 'ACTIVE' : 'INACTIVE') + ')<br>' +
                'Total History: ' + history + ' messages<br>' +
                '<br>' +
                (chat1DOM < history * 0.2 ? '✅ Virtual scrolling is working efficiently!' : '⚠️ Too many DOM nodes')
            );
        }
        
        function clearAll() {
            window.chat1.historyClear();
            window.chat2.historyClear();
            updateStatus('Cleared all messages');
            delete window.xssTest;
        }
        
        // Initial test
        updateStatus('Ready for testing. Click buttons to test virtual scrolling with sanitization.');
    </script>
</body>
</html>